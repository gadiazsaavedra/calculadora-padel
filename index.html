<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Calculadora Pádel</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎾</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: max(10px, env(safe-area-inset-top)) max(10px, env(safe-area-inset-right)) max(10px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        @media screen and (min-width: 768px) {
            .container {
                max-width: 600px;
            }
        }
        
        .header {
            background: #2196F3;
            color: white;
            padding: max(20px, env(safe-area-inset-top) + 10px) 20px 20px 20px;
            text-align: center;
        }
        
        .content {
            padding: 20px;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease forwards;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        input, select, button {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            min-height: 50px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        button {
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1976D2;
        }
        
        .btn-secondary {
            background: #4CAF50;
        }
        
        .btn-secondary:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
        }
        
        .player-item.swiping {
            transform: translateX(var(--swipe-x, 0));
            transition: none;
        }
        
        .player-item.swipe-delete {
            background: #ffebee;
            border-left-color: #f44336;
        }
        
        .swipe-indicator {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #f44336;
            font-size: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .player-item.swipe-delete .swipe-indicator {
            opacity: 1;
        }
        
        /* Modales Nativos */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            max-width: 350px;
            width: 100%;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.show .modal {
            transform: scale(1);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }
        
        .modal-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.4;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-button.primary {
            background: #2196F3;
            color: white;
        }
        
        .modal-button.secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .modal-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .player-color-0 { border-left-color: #2196F3; }
        .player-color-1 { border-left-color: #4CAF50; }
        .player-color-2 { border-left-color: #FF9800; }
        .player-color-3 { border-left-color: #9C27B0; }
        .player-color-4 { border-left-color: #F44336; }
        .player-color-5 { border-left-color: #00BCD4; }
        .player-color-6 { border-left-color: #795548; }
        .player-color-7 { border-left-color: #607D8B; }
        
        .player-info {
            flex: 1;
        }
        
        .player-name {
            font-weight: 600;
            color: #333;
        }
        
        .player-time {
            font-size: 14px;
            color: #666;
        }
        
        .player-cost {
            font-weight: 600;
            color: #2196F3;
            font-size: 18px;
        }
        
        .btn-small {
            padding: 10px 15px;
            font-size: 16px;
            margin-left: 5px;
            min-height: 44px;
        }
        
        .results {
            background: #e8f5e8;
            border-left: 4px solid #4CAF50;
        }
        
        .total-cost {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .status-active {
            border-left-color: #4CAF50;
        }
        
        .status-left {
            border-left-color: #ff9800;
            opacity: 0.7;
        }
        
        .payment-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .paid {
            background: #4CAF50;
            color: white;
        }
        
        .pending {
            background: #ff9800;
            color: white;
        }
        
        .progress-bar {
            background: #f0f0f0;
            height: 6px;
            border-radius: 3px;
            margin: 15px 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: #2196F3;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .step-indicator {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox-item:hover {
            border-color: #2196F3;
            background: #f8f9ff;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-item:has(input:checked) {
            background: #e3f2fd;
            border-color: #2196F3;
            font-weight: 600;
        }
        
        /* Historial */
        .history-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-date {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .history-summary {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .history-players {
            font-size: 12px;
            color: #888;
        }
        
        .history-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-around;
            padding: 10px max(10px, env(safe-area-inset-right)) max(10px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            min-width: 60px;
        }
        
        .nav-item.active {
            background: #e3f2fd;
            color: #2196F3;
        }
        
        .nav-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }
        
        /* Ajustar contenido para bottom nav */
        .container {
            margin-bottom: calc(100px + env(safe-area-inset-bottom));
        }
        
        .toast {
            position: fixed;
            top: max(20px, env(safe-area-inset-top) + 10px);
            right: max(20px, env(safe-area-inset-right) + 10px);
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Modo landscape */
        @media screen and (orientation: landscape) and (max-height: 600px) {
            .container {
                max-width: 90%;
                margin: 5px auto;
            }
            
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 20px;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            .content {
                padding: 15px;
            }
            
            .section {
                margin-bottom: 15px;
                padding: 10px;
            }
            
            .section h3 {
                font-size: 16px;
                margin-bottom: 10px;
            }
            
            .input-group {
                margin-bottom: 10px;
            }
            
            input, select, button {
                padding: 10px;
                font-size: 16px;
                min-height: 40px;
            }
            
            .btn-small {
                padding: 8px 12px;
                font-size: 14px;
                min-height: 36px;
            }
            
            .player-item {
                padding: 8px;
                margin-bottom: 8px;
            }
            
            .step-indicator {
                font-size: 12px;
                margin: 5px 0;
            }
            
            .progress-bar {
                margin: 10px 20px;
                height: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎾 Calculadora Pádel</h1>
            <p style="color: black;">Costos Compartidos Justos</p>
            <div class="step-indicator" id="step-indicator">Paso 1 de 4</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 25%;"></div>
            </div>
        </div>
        
        <div class="content">
            <!-- Configuración de Sesión -->
            <div class="section" id="session-setup">
                <h3>📋 Nueva Sesión</h3>
                <div class="input-group">
                    <label>Hora de Inicio</label>
                    <input type="time" id="start-time" inputmode="numeric" required>
                </div>
                <button onclick="startSession()">▶️ Iniciar Sesión</button>
            </div>
            
            <!-- Jugadores Iniciales -->
            <div class="section hidden" id="initial-players">
                <h3>🏁 Jugadores Iniciales</h3>
                <div class="input-group">
                    <label>Seleccionar jugadores que empiezan:</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-item"><input type="checkbox" value="Ariel"> Ariel</label>
                        <label class="checkbox-item"><input type="checkbox" value="Claudio"> Claudio</label>
                        <label class="checkbox-item"><input type="checkbox" value="Dario"> Dario</label>
                        <label class="checkbox-item"><input type="checkbox" value="Federico"> Federico</label>
                        <label class="checkbox-item"><input type="checkbox" value="Gustavo"> Gustavo</label>
                        <label class="checkbox-item"><input type="checkbox" value="Hugo"> Hugo</label>
                        <label class="checkbox-item"><input type="checkbox" value="Mariano"> Mariano</label>
                        <label class="checkbox-item"><input type="checkbox" value="Yel"> Yel</label>
                        <label class="checkbox-item"><input type="checkbox" value="GuestPlayer1"> GuestPlayer 1 (+$1000)</label>
                        <label class="checkbox-item"><input type="checkbox" value="GuestPlayer2"> GuestPlayer 2 (+$1000)</label>
                    </div>
                </div>
                <button onclick="addInitialPlayers()" class="btn-secondary">👥 Agregar Jugadores Iniciales</button>
            </div>
            
            <!-- Gestión de Jugadores -->
            <div class="section hidden" id="player-management">
                <h3>👥 Agregar Jugador</h3>
                <div class="input-group">
                    <label>Nombre del Jugador</label>
                    <select id="player-name" onchange="toggleCustomName()">
                        <option value="">Seleccionar jugador...</option>
                        <option value="Ariel">Ariel</option>
                        <option value="Claudio">Claudio</option>
                        <option value="Dario">Dario</option>
                        <option value="Federico">Federico</option>
                        <option value="Gustavo">Gustavo</option>
                        <option value="Hugo">Hugo</option>
                        <option value="Mariano">Mariano</option>
                        <option value="Yel">Yel</option>
                        <option value="GuestPlayer1">GuestPlayer 1 (+$1000)</option>
                        <option value="GuestPlayer2">GuestPlayer 2 (+$1000)</option>
                        <option value="custom">Otro jugador...</option>
                    </select>
                </div>
                <div class="input-group hidden" id="custom-name-group">
                    <label>Nombre Personalizado</label>
                    <input type="text" id="custom-player-name" placeholder="Ingresa el nombre" autocomplete="name" autocapitalize="words">
                </div>
                <div class="input-group">
                    <label>Hora de Llegada</label>
                    <input type="time" id="arrival-time" inputmode="numeric">
                </div>
                <button onclick="addPlayer()" class="btn-secondary">➕ Agregar Jugador</button>
            </div>
            
            <!-- Lista de Jugadores Activos -->
            <div class="section hidden" id="active-players">
                <h3>🏃‍♂️ Jugadores en Sesión</h3>
                <div id="players-list"></div>
            </div>
            
            <!-- Finalizar Sesión -->
            <div class="section hidden" id="session-end">
                <h3>🏁 Finalizar Sesión</h3>
                <button onclick="allPlayersStay()" class="btn-secondary" style="margin-bottom: 15px;">👥 Todos se Quedan Hasta el Final</button>
                <div class="input-group">
                    <label>Hora de Fin</label>
                    <input type="time" id="end-time" inputmode="numeric">
                </div>
                <div class="input-group">
                    <label>Costo Total de la Cancha ($)</label>
                    <input type="number" id="total-cost" placeholder="Ej: 8000" inputmode="numeric" pattern="[0-9]*" required>
                </div>
                <button onclick="endSession()" class="btn-danger">🏁 Finalizar y Calcular</button>
            </div>
            
            <!-- Resultados -->
            <div class="section results hidden" id="results">
                <h3>💰 Resultados del Cálculo</h3>
                <div class="total-cost" id="total-display"></div>
                <div id="results-list"></div>
                <button onclick="shareResults()" style="margin-top: 20px; margin-right: 10px;" class="btn-secondary">📱 Compartir por WhatsApp</button>
                <button onclick="resetApp()" style="margin-top: 20px;">Nueva Sesión</button>
            </div>
            
            <!-- Historial -->
            <div class="section hidden" id="history">
                <h3>📋 Historial de Sesiones</h3>
                <div id="history-list"></div>
                <button onclick="clearHistory()" class="btn-danger" style="margin-top: 15px;">🗑️ Limpiar Historial</button>
            </div>
        </div>
        
        <div style="text-align: center; padding: 20px; color: #666; font-size: 14px; border-top: 1px solid #eee; margin-top: 20px;">
            Creado por Gustavo - Porque el pádel une, pero los gastos dividen.
        </div>
    </div>
    
    <!-- Modal Nativo -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-message" id="modal-message"></div>
            <input type="text" class="modal-input hidden" id="modal-input" placeholder="">
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="navigateToStep(1)" id="nav-setup">
            <div class="nav-icon">▶️</div>
            <div class="nav-label">Inicio</div>
        </div>
        <div class="nav-item disabled" onclick="navigateToStep(2)" id="nav-players">
            <div class="nav-icon">👥</div>
            <div class="nav-label">Jugadores</div>
        </div>
        <div class="nav-item disabled" onclick="navigateToStep(3)" id="nav-session">
            <div class="nav-icon">🎾</div>
            <div class="nav-label">Sesión</div>
        </div>
        <div class="nav-item disabled" onclick="navigateToStep(4)" id="nav-results">
            <div class="nav-icon">📊</div>
            <div class="nav-label">Resultados</div>
        </div>
        <div class="nav-item" onclick="showHistory()" id="nav-history">
            <div class="nav-icon">📋</div>
            <div class="nav-label">Historial</div>
        </div>
    </div>

    <script>
        // Todo el JavaScript embebido para compatibilidad móvil
        // Estado global de la aplicación
        let sessionData = {
            startTime: null,
            endTime: null,
            totalCost: 0,
            players: [],
            isActive: false
        };
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5);
            document.getElementById('arrival-time').value = currentTime;
            initSwipeGestures();
            loadSession();
        });
        
        // Persistencia de datos
        function saveSession() {
            try {
                localStorage.setItem('padelSession', JSON.stringify(sessionData));
            } catch (error) {
                console.error('Error guardando sesión:', error);
            }
        }
        
        function saveToHistory() {
            if (!sessionData.totalCost || sessionData.players.length === 0) return;
            
            try {
                const history = JSON.parse(localStorage.getItem('padelHistory') || '[]');
                const sessionRecord = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('es-ES'),
                    startTime: sessionData.startTime,
                    endTime: sessionData.endTime,
                    totalCost: sessionData.totalCost,
                    players: sessionData.players.map(p => ({
                        name: p.name,
                        cost: p.cost,
                        effectiveMinutes: p.effectiveMinutes,
                        paid: p.paid,
                        isGuest: p.isGuest
                    }))
                };
                
                history.unshift(sessionRecord);
                if (history.length > 20) history.pop(); // Mantener solo 20 sesiones
                
                localStorage.setItem('padelHistory', JSON.stringify(history));
            } catch (error) {
                console.error('Error guardando historial:', error);
            }
        }
        
        function loadSession() {
            try {
                const saved = localStorage.getItem('padelSession');
                if (saved) {
                    const data = JSON.parse(saved);
                    // Solo cargar si hay una sesión activa
                    if (data.isActive || data.totalCost > 0) {
                        sessionData = data;
                        restoreSession();
                    }
                }
            } catch (error) {
                console.error('Error cargando sesión:', error);
            }
        }
        
        function restoreSession() {
            if (sessionData.startTime) {
                document.getElementById('start-time').value = sessionData.startTime;
            }
            if (sessionData.endTime) {
                document.getElementById('end-time').value = sessionData.endTime;
            }
            if (sessionData.totalCost > 0) {
                document.getElementById('total-cost').value = sessionData.totalCost;
            }
            
            // Restaurar vista según el estado
            if (sessionData.totalCost > 0) {
                // Mostrar resultados
                showResults();
            } else if (sessionData.players.length > 0) {
                // Mostrar gestión de sesión
                document.getElementById('session-setup').classList.add('hidden');
                document.getElementById('initial-players').classList.add('hidden');
                document.getElementById('player-management').classList.remove('hidden');
                document.getElementById('session-end').classList.remove('hidden');
                document.getElementById('active-players').classList.remove('hidden');
                updateProgress(3, 'Gestionar sesión');
                updatePlayersDisplay();
            } else if (sessionData.isActive) {
                // Mostrar selección de jugadores iniciales
                document.getElementById('session-setup').classList.add('hidden');
                document.getElementById('initial-players').classList.remove('hidden');
                document.getElementById('active-players').classList.remove('hidden');
                updateProgress(2, 'Agregar jugadores iniciales');
            }
            
            if (sessionData.startTime || sessionData.players.length > 0 || sessionData.totalCost > 0) {
                showToast('Sesión anterior restaurada');
            }
        }
        
        // Iniciar nueva sesión
        function startSession() {
            const startTime = document.getElementById('start-time').value;
            
            if (!startTime) {
                alert('Por favor ingresa la hora de inicio');
                return;
            }
            
            sessionData = {
                startTime: startTime,
                endTime: null,
                totalCost: 0,
                players: [],
                isActive: true
            };
            
            document.getElementById('session-setup').classList.add('hidden');
            document.getElementById('initial-players').classList.remove('hidden');
            document.getElementById('active-players').classList.remove('hidden');
            
            updateProgress(2, 'Agregar jugadores iniciales');
            updatePlayersDisplay();
            saveSession();
        }
        
        // Funciones esenciales embebidas
        function updateProgress(step, description) {
            const stepIndicator = document.getElementById('step-indicator');
            const progressFill = document.getElementById('progress-fill');
            
            stepIndicator.textContent = `Paso ${step} de 4: ${description}`;
            progressFill.style.width = `${(step / 4) * 100}%`;
            
            updateBottomNav(step);
        }
        
        function updateBottomNav(currentStep) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                item.classList.add('disabled');
            });
            
            for (let i = 1; i <= currentStep; i++) {
                const stepIds = { 1: 'setup', 2: 'players', 3: 'session', 4: 'results' };
                const navItem = document.getElementById(`nav-${stepIds[i]}`);
                if (navItem) {
                    navItem.classList.remove('disabled');
                    if (i === currentStep) {
                        navItem.classList.add('active');
                    }
                }
            }
        }
        
        function updatePlayersDisplay() {
            const container = document.getElementById('players-list');
            
            if (sessionData.players.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No hay jugadores en la sesión</p>';
                return;
            }
            
            container.innerHTML = sessionData.players.map((player, index) => {
                const statusClass = player.isActive ? 'status-active' : 'status-left';
                const statusText = player.isActive ? 'En juego' : `Salió: ${player.departureTime}`;
                const colorClass = `player-color-${index % 8}`;
                
                return `
                    <div class="player-item ${statusClass} ${colorClass}" data-player-id="${player.id}">
                        <div class="swipe-indicator">❌</div>
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-time">Llegó: ${player.arrivalTime} | ${statusText}</div>
                        </div>
                        <div>
                            ${player.isActive ? 
                                `<button class="btn-small" onclick="markPlayerDeparture(${player.id})">🚪 Marcar Salida</button>` : 
                                ''
                            }
                            <button class="btn-small btn-danger" onclick="removePlayer(${player.id})">❌ Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function initSwipeGestures() {
            // Swipe gestures básicos para futuras mejoras
        }
        
        // Agregar jugadores iniciales
        function addInitialPlayers() {
            const checkboxes = document.querySelectorAll('#initial-players input[type="checkbox"]:checked');
            const selectedPlayers = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedPlayers.length === 0) {
                alert('Selecciona al menos un jugador marcando las casillas');
                return;
            }
            
            const players = selectedPlayers.filter(name => !sessionData.players.find(p => p.name === name));
            
            if (players.length === 0) {
                alert('Los jugadores seleccionados ya están en la sesión');
                return;
            }
            
            players.forEach(name => {
                const player = {
                    id: Date.now() + Math.random(),
                    name: name,
                    arrivalTime: sessionData.startTime,
                    departureTime: null,
                    isActive: true,
                    paid: false,
                    isGuest: name === 'GuestPlayer1' || name === 'GuestPlayer2'
                };
                sessionData.players.push(player);
            });
            
            // Limpiar selecciones
            document.querySelectorAll('#initial-players input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            // Mostrar secciones restantes
            document.getElementById('initial-players').classList.add('hidden');
            document.getElementById('player-management').classList.remove('hidden');
            document.getElementById('session-end').classList.remove('hidden');
            
            updateProgress(3, 'Gestionar sesión');
            showToast(`${players.length} jugador${players.length > 1 ? 'es' : ''} agregado${players.length > 1 ? 's' : ''}`);
            updatePlayersDisplay();
            saveSession();
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function markPlayerDeparture(playerId) {
            showTimeModal('Hora de salida', 'Selecciona la hora de salida:', new Date().toTimeString().slice(0, 5))
                .then(departureTime => {
                    if (!departureTime) return;
                    
                    const player = sessionData.players.find(p => p.id === playerId);
                    if (player) {
                        player.departureTime = departureTime;
                        player.isActive = false;
                        updatePlayersDisplay();
                        saveSession();
                    }
                });
        }
        
        // Modal con input de tiempo nativo
        function showTimeModal(title, message, defaultValue = '') {
            return new Promise((resolve) => {
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const messageEl = document.getElementById('modal-message');
                const inputEl = document.getElementById('modal-input');
                const buttonsEl = document.getElementById('modal-buttons');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                inputEl.classList.remove('hidden');
                inputEl.type = 'time';
                inputEl.value = defaultValue;
                inputEl.placeholder = '';
                
                buttonsEl.innerHTML = `
                    <button class="modal-button secondary" onclick="closeModal(); window.modalResolve(null);">Cancelar</button>
                    <button class="modal-button primary" onclick="closeModal(); window.modalResolve(document.getElementById('modal-input').value);">OK</button>
                `;
                
                overlay.classList.add('show');
                setTimeout(() => inputEl.focus(), 300);
                window.modalResolve = resolve;
            });
        }
        
        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.remove('show');
        }
        
        // Compartir resultados por WhatsApp
        function shareResults() {
            const today = new Date().toLocaleDateString('es-ES');
            const totalCalculated = sessionData.players.reduce((sum, p) => sum + p.cost, 0);
            const totalPaid = sessionData.players.reduce((sum, p) => sum + (p.paid ? p.cost : 0), 0);
            const saldo = totalCalculated - sessionData.totalCost;
            
            let message = `🎾 RESULTADOS PÁDEL - ${today}\n\n`;
            message += `💰 Costo total: $${formatCurrency(sessionData.totalCost)}\n`;
            message += `⏰ Sesión: ${sessionData.startTime} - ${sessionData.endTime}\n\n`;
            message += `👥 PAGOS POR JUGADOR:\n`;
            
            sessionData.players.forEach(player => {
                const status = player.paid ? '✅ Pagado' : '⏳ Pendiente';
                const hours = (player.effectiveMinutes / 60).toFixed(1);
                const guestNote = player.isGuest ? ' +$1000' : '';
                message += `• ${player.name}: $${formatCurrency(player.cost)} (${hours}h${guestNote}) ${status}\n`;
            });
            
            message += `\n📄 RESUMEN:\n`;
            message += `Recaudado: $${formatCurrency(totalPaid)}\n`;
            message += `Pendiente: $${formatCurrency(totalCalculated - totalPaid)}\n`;
            message += `Saldo: ${saldo >= 0 ? '+' : ''}$${formatCurrency(Math.abs(saldo))}`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function removePlayer(playerId) {
            if (confirm('¿Eliminar este jugador de la sesión?')) {
                sessionData.players = sessionData.players.filter(p => p.id !== playerId);
                updatePlayersDisplay();
                saveSession();
            }
        }
        
        // Mostrar/ocultar campo de nombre personalizado
        function toggleCustomName() {
            const select = document.getElementById('player-name');
            const customGroup = document.getElementById('custom-name-group');
            
            if (select.value === 'custom') {
                customGroup.classList.remove('hidden');
            } else {
                customGroup.classList.add('hidden');
                document.getElementById('custom-player-name').value = '';
            }
        }
        
        // Agregar jugador individual
        function addPlayer() {
            const selectValue = document.getElementById('player-name').value;
            const customName = document.getElementById('custom-player-name').value.trim();
            const arrivalTime = document.getElementById('arrival-time').value;
            
            let name = '';
            if (selectValue === 'custom') {
                if (!customName) {
                    alert('Por favor ingresa el nombre del jugador personalizado');
                    return;
                }
                name = customName;
            } else {
                name = selectValue;
            }
            
            if (!name || !arrivalTime) {
                alert('Por favor completa el nombre y la hora de llegada');
                return;
            }
            
            if (sessionData.players.find(p => p.name === name)) {
                alert('Este jugador ya está en la sesión');
                return;
            }
            
            const player = {
                id: Date.now(),
                name: name,
                arrivalTime: arrivalTime,
                departureTime: null,
                isActive: true,
                paid: false,
                isGuest: name === 'GuestPlayer1' || name === 'GuestPlayer2'
            };
            
            sessionData.players.push(player);
            
            // Limpiar campos
            document.getElementById('player-name').value = '';
            document.getElementById('custom-player-name').value = '';
            document.getElementById('custom-name-group').classList.add('hidden');
            document.getElementById('arrival-time').value = new Date().toTimeString().slice(0, 5);
            
            showToast(`${name} agregado a la sesión`);
            updatePlayersDisplay();
            saveSession();
        }
        
        // Finalizar sesión y calcular
        function endSession() {
            const endTime = document.getElementById('end-time').value;
            const totalCost = parseFloat(document.getElementById('total-cost').value);
            
            if (!endTime || !totalCost || totalCost <= 0) {
                alert('Por favor completa la hora de fin y el costo total');
                return;
            }
            
            if (sessionData.players.length === 0) {
                alert('No hay jugadores para calcular');
                return;
            }
            
            sessionData.endTime = endTime;
            sessionData.totalCost = totalCost;
            sessionData.isActive = false;
            
            calculateCosts();
            saveToHistory();
            showResults();
            saveSession();
        }
        
        function calculateCosts() {
            const sessionStart = timeToMinutes(sessionData.startTime);
            const sessionEnd = timeToMinutes(sessionData.endTime);
            let totalPlayerMinutes = 0;
            
            sessionData.players.forEach(player => {
                const playerStart = timeToMinutes(player.arrivalTime);
                const playerEnd = player.departureTime ? 
                    timeToMinutes(player.departureTime) : 
                    sessionEnd;
                
                const playerMinutes = Math.max(0, playerEnd - playerStart);
                player.effectiveMinutes = playerMinutes;
                totalPlayerMinutes += playerMinutes;
            });
            
            sessionData.players.forEach(player => {
                const playerProportion = player.effectiveMinutes / totalPlayerMinutes;
                const playerCost = sessionData.totalCost * playerProportion;
                const baseCost = Math.round(playerCost / 100) * 100;
                player.cost = player.isGuest ? baseCost + 1000 : baseCost;
                player.proportion = playerProportion;
            });
        }
        
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + (minutes || 0);
        }
        
        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }
        
        function formatCurrency(amount) {
            return amount.toLocaleString('es-AR');
        }
        
        function showResults() {
            document.getElementById('player-management').classList.add('hidden');
            document.getElementById('session-end').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            
            document.getElementById('total-display').textContent = `Costo Total: $${formatCurrency(sessionData.totalCost)}`;
            updateProgress(4, 'Resultados finales');
            
            const resultsContainer = document.getElementById('results-list');
            const totalCalculated = sessionData.players.reduce((sum, p) => sum + p.cost, 0);
            
            resultsContainer.innerHTML = `
                ${sessionData.players.map((player, index) => {
                    const colorClass = `player-color-${index % 8}`;
                    return `
                    <div class="player-item ${colorClass}">
                        <div class="player-info">
                            <div class="player-name">
                                ${player.name}
                                <span class="payment-status ${player.paid ? 'paid' : 'pending'}">
                                    ${player.paid ? 'Pagado' : 'Pendiente'}
                                </span>
                            </div>
                            <div class="player-time">
                                T: ${minutesToTime(player.effectiveMinutes)}<br>
                                (${(player.proportion * 100).toFixed(1)}%)${player.isGuest ? ' + $1000 recargo' : ''}
                            </div>
                        </div>
                        <div class="player-cost">$${formatCurrency(player.cost)}</div>
                        <button class="btn-small ${player.paid ? 'btn-danger' : 'btn-secondary'}" 
                                onclick="togglePayment(${player.id})">
                            ${player.paid ? '❌ Marcar Impago' : '✅ Marcar Pagado'}
                        </button>
                    </div>
                `}).join('')}
                
                <div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span><strong>Total a Cobrar:</strong></span>
                        <span style="color: #2196F3;"><strong>$${formatCurrency(sessionData.totalCost)}</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span><strong>Total Calculado:</strong></span>
                        <span style="color: #333;"><strong>$${formatCurrency(totalCalculated)}</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span><strong>Total Recaudado:</strong></span>
                        <span style="color: #4CAF50;"><strong>$${formatCurrency(sessionData.players.reduce((sum, p) => sum + (p.paid ? p.cost : 0), 0))}</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>Saldo:</strong></span>
                        <span style="color: ${totalCalculated - sessionData.totalCost >= 0 ? '#4CAF50' : '#f44336'};"><strong>${totalCalculated - sessionData.totalCost >= 0 ? '+' : ''}$${formatCurrency(Math.abs(totalCalculated - sessionData.totalCost))}</strong></span>
                    </div>
                </div>
            `;
        }
        
        function togglePayment(playerId) {
            const player = sessionData.players.find(p => p.id === playerId);
            if (player) {
                player.paid = !player.paid;
                showResults();
                saveSession();
            }
        }
        
        function resetApp() {
            if (confirm('¿Iniciar una nueva sesión? Se perderán los datos actuales.')) {
                localStorage.removeItem('padelSession');
                document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
                document.getElementById('session-setup').classList.remove('hidden');
                updateProgress(1, 'Configurar sesión');
                
                sessionData = {
                    startTime: null,
                    endTime: null,
                    totalCost: 0,
                    players: [],
                    isActive: false
                };
                
                document.getElementById('start-time').value = '';
                document.getElementById('end-time').value = '';
                document.getElementById('total-cost').value = '';
            }
        }
        
        function navigateToStep(step) {
            // Navegación entre pasos (funcionalidad futura)
        }
        
        function showHistory() {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById('history').classList.remove('hidden');
            
            const history = JSON.parse(localStorage.getItem('padelHistory') || '[]');
            const container = document.getElementById('history-list');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No hay sesiones guardadas</p>';
                return;
            }
            
            container.innerHTML = history.map(session => {
                const totalPaid = session.players.reduce((sum, p) => sum + (p.paid ? p.cost : 0), 0);
                const playerNames = session.players.map(p => p.name).join(', ');
                
                return `
                    <div class="history-item">
                        <div class="history-date">${session.date}</div>
                        <div class="history-summary">
                            ${session.startTime} - ${session.endTime} | $${formatCurrency(session.totalCost)}
                        </div>
                        <div class="history-players">
                            ${session.players.length} jugadores: ${playerNames}
                        </div>
                        <div class="history-actions">
                            <button class="btn-small btn-secondary" onclick="viewSessionDetails(${session.id})">👁️ Ver</button>
                            <button class="btn-small btn-danger" onclick="deleteSession(${session.id})">❌ Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function viewSessionDetails(sessionId) {
            const history = JSON.parse(localStorage.getItem('padelHistory') || '[]');
            const session = history.find(s => s.id === sessionId);
            if (!session) return;
            
            let details = `🏦 SESIÓN DEL ${session.date}\n\n`;
            details += `⏰ Horario: ${session.startTime} - ${session.endTime}\n`;
            details += `💰 Costo total: $${formatCurrency(session.totalCost)}\n\n`;
            details += `👥 JUGADORES:\n`;
            
            session.players.forEach(player => {
                const hours = (player.effectiveMinutes / 60).toFixed(1);
                const status = player.paid ? '✅' : '⏳';
                const guestNote = player.isGuest ? ' +$1000' : '';
                details += `• ${player.name}: $${formatCurrency(player.cost)} (${hours}h${guestNote}) ${status}\n`;
            });
            
            alert(details);
        }
        
        function deleteSession(sessionId) {
            if (confirm('¿Eliminar esta sesión del historial?')) {
                const history = JSON.parse(localStorage.getItem('padelHistory') || '[]');
                const filtered = history.filter(s => s.id !== sessionId);
                localStorage.setItem('padelHistory', JSON.stringify(filtered));
                showHistory();
            }
        }
        
        function clearHistory() {
            if (confirm('¿Eliminar todo el historial? Esta acción no se puede deshacer.')) {
                localStorage.removeItem('padelHistory');
                showHistory();
            }
        }
        
        // Navegación mejorada
        document.addEventListener('keydown', function(e) {
            if (e.key === 'h' && e.ctrlKey) {
                e.preventDefault();
                showHistory();
            }
        });
        
        // App cargada correctamente
    </script>
</body>
</html>